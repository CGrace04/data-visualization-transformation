---
title: "Grammar of graphics"
format: revealjs
---

```{r}
#| include: false

library(tidyverse)
library(palmerpenguins)
```

```{r}
#| label: gg-setup
#| echo: false

gg_layers <- tribble(
  ~x,    ~y, ~layer,
  -1,     0, "Data",
   0,  0.75, "Data",
   1,     0, "Data",
   0, -0.75, "Data",
  -1,   0.5, "Aesthetics",
   0,  1.25, "Aesthetics",
   1,   0.5, "Aesthetics",
   0, -0.25, "Aesthetics",
  -1,     1, "Geometries",
   0,  1.75, "Geometries",
   1,     1, "Geometries",
   0,  0.25, "Geometries",
  -1,   1.5, "Facets",
   0,  2.25, "Facets",
   1,   1.5, "Facets",
   0,  0.75, "Facets",
  -1,     2, "Statistics",
   0,  2.75, "Statistics",
   1,     2, "Statistics",
   0,  1.25, "Statistics",
  -1,   2.5, "Coordinates",
   0,  3.25, "Coordinates",
   1,   2.5, "Coordinates",
   0,  1.75, "Coordinates",
  -1,     3, "Themes",
   0,  3.75, "Themes",
   1,     3, "Themes",
   0,  2.25, "Themes"
)

gg_colors <- tribble(
  ~layer,        ~color,
  "Data",        "#000000",
  "Aesthetics",  "#0072B2",
  "Geometries",  "#56B4E9",
  "Facets",      "#009E73",
  "Statistics",  "#E69F00",
  "Coordinates", "#D55E00",
  "Themes",      "#CC79A7"
) |>
  rowid_to_column(var = "layer_no")

gg <- gg_layers |> 
  left_join(gg_colors, by = join_by(layer)) |>
  mutate(layer = fct_reorder(layer, layer_no))

gg_diagram <- gg |>
  ggplot(aes(x = x, y = y, fill = layer)) +
  geom_polygon(alpha = 0.5, show.legend = FALSE) +
  geom_text(
    data = gg |> filter(x == 1) |> mutate(layer = fct_reorder(layer, layer_no)), 
    aes(label = layer, color = layer), 
    show.legend = FALSE,
    hjust = 0, nudge_x = 0.05,
    size = 12
  ) +
  coord_cartesian(clip = "off", xlim = c(-1, 3), ylim = c(-1, 4)) +
  theme_void() +
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA)
  )
```

# Grammar of graphics

## Review: Grammar of Graphics

:::: {.columns}

::: {.column width="30%"}
- Grammar of graphics is a tool that enables us to concisely describe the components of a graphic

- ggplot2 is an implementation of grammar of graphics in R
:::

::: {.column width="40%"}
```{r}
#| label: gg
#| echo: false
#| fig-width: 6
#| fig-asp: 0.9

gg_diagram +
  scale_fill_manual(values = gg_colors$color) +
  scale_color_manual(values = gg_colors$color)
```
:::

::::

# Layer 1: Data {.section-break}

```{r dev = "png", dev.args = list(bg = "transparent")}
#| label: gg-data
#| echo: false
#| fig-width: 8
#| fig-asp: 0.9

gg_diagram +
  scale_fill_manual(values = c(gg_colors$color[1], rep("#5686b0", 6))) +
  scale_color_manual(values = c(gg_colors$color[1], rep("#5686b0", 6)))
```

## Data

- The data layer is the foundation of the plot

- It gives you the canvas on which you can "paint" your data

```{r}
#| fig-width: 8

ggplot(penguins)
```

# Aesthetics {.section-break}

## Aesthetics options

Commonly used characteristics of plotting characters that can be **mapped to a specific variable** in the data are

-   `color`
-   `shape`
-   `size`
-   `alpha` (transparency)

## color

```{r}
#| output-location: column
ggplot(penguins,
       aes(x = bill_depth_mm, 
           y = bill_length_mm,
           color = species)) +
  geom_point() +
  scale_color_viridis_d()
```

## Shape

Mapped to a different variable than `color`

```{r}
#| output-location: column
ggplot(penguins,
       aes(x = bill_depth_mm, 
           y = bill_length_mm,
           color = species,
           shape = island)) + #<<
  geom_point() +
  scale_color_viridis_d()
```

## Shape

Mapped to same variable as `color`

```{r}
#| output-location: column
ggplot(penguins,
       aes(x = bill_depth_mm, 
           y = bill_length_mm,
           color = species,
           shape = species)) +
  geom_point() +
  scale_color_viridis_d()
```

## Size

```{r}
#| output-location: column

ggplot(penguins,
       aes(x = bill_depth_mm, 
           y = bill_length_mm,
           color = species,
           shape = species,
           size = body_mass_g)) +
  geom_point() +
  scale_color_viridis_d()
```

## Alpha

```{r}
#| output-location: column

ggplot(penguins,
       aes(x = bill_depth_mm, 
           y = bill_length_mm,
           color = species,
           shape = species,
           size = body_mass_g,
           alpha = flipper_length_mm)) + #<<
  geom_point() +
  scale_color_viridis_d()
```

## Mapping vs. setting

::: columns
::: {.column width="50%"}
**Mapping:**

```{r}
ggplot(penguins,
       aes(x = bill_depth_mm,
           y = bill_length_mm,
           size = body_mass_g, #<<
           alpha = flipper_length_mm)) + #<<
  geom_point()
```
:::

::: {.column width="50%"}
**Setting:**

```{r warning = FALSE, out.width = "100%"}
ggplot(penguins,
       aes(x = bill_depth_mm,
           y = bill_length_mm)) + 
  geom_point(size = 2, alpha = 0.5)
```
:::
:::

## Mapping vs. setting

-   **Mapping:** Determine the size, alpha, etc. of points based on the values of a variable in the data
    -   goes into `aes()`
-   **Setting:** Determine the size, alpha, etc. of points **not** based on the values of a variable in the data
    -   goes into `geom_*()` (this was `geom_point()` in the previous example, but we'll learn about other geoms soon!)

class: middle

# Faceting

## Faceting

-   Smaller plots that display different subsets of the data
-   Useful for exploring conditional relationships and large data

.panelset\[ .panel\[.panel-name\[Plot\]

```{r ref.label = "facet", echo = FALSE, warning = FALSE, out.width = "70%"}
```

.panel\[.panel-name\[Code\]

```{r facet, fig.show = "hide"}
ggplot(penguins, aes(x = bill_depth_mm, y = bill_length_mm)) + 
  geom_point() +
  facet_grid(species ~ island) #<<
```

## Various ways to facet

.question\[ In the next few slides describe what each plot displays.
Think about how the code relates to the output.

**Note:** The plots in the next few slides do not have proper titles, axis labels, etc. because we want you to figure out what's happening in the plots.
But you should always label your plots!

```{r warning = FALSE}
ggplot(penguins, aes(x = bill_depth_mm, y = bill_length_mm)) + 
  geom_point() +
  facet_grid(species ~ sex) #<<
```

```{r warning = FALSE}
ggplot(penguins, aes(x = bill_depth_mm, y = bill_length_mm)) + 
  geom_point() +
  facet_grid(sex ~ species) #<<
```

```{r warning = FALSE, fig.asp = 0.5}
ggplot(penguins, aes(x = bill_depth_mm, y = bill_length_mm)) + 
  geom_point() +
  facet_wrap(~ species) #<<
```

```{r warning = FALSE, fig.asp = 0.5}
ggplot(penguins, aes(x = bill_depth_mm, y = bill_length_mm)) + 
  geom_point() +
  facet_grid(. ~ species) #<<
```

```{r warning = FALSE}
ggplot(penguins, aes(x = bill_depth_mm, y = bill_length_mm)) + 
  geom_point() +
  facet_wrap(~ species, ncol = 2) #<<
```

## Faceting summary

-   `facet_grid()`:
    -   2d grid
    -   `rows ~ cols`
    -   use `.` for no split
-   `facet_wrap()`: 1d ribbon wrapped according to number of rows and columns specified or available plotting area

## Facet and color

.pull-left-narrow\[

```{r facet-color-legend, fig.show = "hide", warning = FALSE}
ggplot(
  penguins, 
  aes(x = bill_depth_mm, 
      y = bill_length_mm, 
      color = species)) + #<<
  geom_point() +
  facet_grid(species ~ sex) +
  scale_color_viridis_d() #<<
```

.pull-right-wide\[

```{r ref.label = "facet-color-legend", echo = FALSE, warning = FALSE, out.width = "100%"}
```

## Face and color, no legend

.pull-left-narrow\[

```{r facet-color-no-legend, fig.show = "hide", warning = FALSE}
ggplot(
  penguins, 
  aes(x = bill_depth_mm, 
      y = bill_length_mm, 
      color = species)) +
  geom_point() +
  facet_grid(species ~ sex) +
  scale_color_viridis_d() +
  guides(color = "none") #<<
```

.pull-right-wide\[

```{r ref.label = "facet-color-no-legend", echo = FALSE, warning = FALSE, out.width = "100%"}
```

# Summary

